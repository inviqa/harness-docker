{% if @('pipeline.publish.enabled') %}
        stage('Publish') {
{% set env = @('pipeline.publish.environment') %}
{% set ssh_credential_id = @('pipeline.publish.chart.git.ssh_credential_id') %}
{% if env or ssh_credential_id %}
            environment {
{% for key, value in env %}
                {{ key }} = {{ value }}
{% endfor %}
{% if ssh_credential_id %}
                WS_APP_PUBLISH_CHART_SSH_PRIVATE_KEY = credentials('{{ ssh_credential_id }}')
{% endif %}
            }
{% endif %}
            when {
                not { triggeredBy 'TimerTrigger' }
                anyOf {
{% for branch in @('pipeline.publish.branches') %}
                    branch '{{ branch }}'
{% endfor %}
{% if @('pipeline.qa.enabled') %}
                    branch '{{ @('pipeline.qa.branch') }}'
{% endif %}
{% if @('pipeline.preview.enabled') %}
{% for branch in @('pipeline.preview.target_branches') %}
                    changeRequest target: '{{ branch }}'
{% endfor %}
{% endif %}
                }
            }
            steps {
                milestone(50)
                sh 'ws app publish'
{% if @('pipeline.publish.chart.enabled') %}
                lock(resource: '{{ @('pipeline.publish.chart.git.repository') }}', inversePrecedence: true) {
                    sh 'ws app publish chart "${GIT_BRANCH}" "{{ @('workspace.name') }} build artifact ${GIT_COMMIT}"'
                }
{% endif %}
            }
        }
{% endif %}
